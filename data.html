<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data &mdash; OpenNMT-tf 2.32.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vocabulary" href="vocabulary.html" />
    <link rel="prev" title="Parameters" href="configuration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> OpenNMT-tf
            <img src="_static/logo-alpha.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.32
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Parameters</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#terminology">Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="#file-format">File format</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#text">Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sequence-vector">Sequence vector</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#via-python">via Python</a></li>
<li class="toctree-l4"><a class="reference internal" href="#via-the-ark-text-format">via the ARK text format</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-and-nested-inputs">Parallel and nested inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#weighted-dataset">Weighted dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compressed-data">Compressed data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-location">Data location</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="vocabulary.html">Vocabulary</a></li>
<li class="toctree-l1"><a class="reference internal" href="tokenization.html">Tokenization</a></li>
<li class="toctree-l1"><a class="reference internal" href="embeddings.html">Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="alignments.html">Alignments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving.html">Serving</a></li>
<li class="toctree-l1"><a class="reference internal" href="v2_transition.html">2.0 Transition Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="package/overview.html">Python</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpenNMT-tf</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="data">
<h1>Data<a class="headerlink" href="#data" title="Permalink to this headline"></a></h1>
<p>Data files are configured in the <code class="docutils literal notranslate"><span class="pre">data</span></code> block of the YAML configuration file (see <a class="reference internal" href="configuration.html"><span class="doc std std-doc">Parameters</span></a>). For example, here is a typical data configuration for a sequence to sequence model:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train_features_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/ende/train.en</span>
<span class="w">  </span><span class="nt">train_labels_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/ende/train.de</span>
<span class="w">  </span><span class="nt">eval_features_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/ende/valid.en</span><span class="w">  </span><span class="c1"># optional</span>
<span class="w">  </span><span class="nt">eval_labels_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/ende/valid.de</span><span class="w">    </span><span class="c1"># optional</span>
</pre></div>
</div>
<p>This page documents how to prepare and configure data files for OpenNMT-tf.</p>
<section id="terminology">
<h2>Terminology<a class="headerlink" href="#terminology" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><em>features</em>: the model inputs (a.k.a. the <em>source</em>)</p></li>
<li><p><em>labels</em>: the model outputs (a.k.a. the <em>target</em>)</p></li>
<li><p><em>inputters</em>: the input layer of the model that defines how to read element and transform them into vectorized inputs</p></li>
</ul>
</section>
<section id="file-format">
<h2>File format<a class="headerlink" href="#file-format" title="Permalink to this headline"></a></h2>
<p>The format of the data files is defined by the <code class="docutils literal notranslate"><span class="pre">opennmt.inputters.Inputter</span></code> modules used by your model. OpenNMT-tf currently supports texts and sequence vectors as inputs.</p>
<section id="text">
<h3>Text<a class="headerlink" href="#text" title="Permalink to this headline"></a></h3>
<p>All <a class="reference external" href="https://opennmt.net/OpenNMT-tf/package/opennmt.inputters.TextInputter.html"><code class="docutils literal notranslate"><span class="pre">opennmt.inputters.TextInputter</span></code></a> inputters expect a text file as input where:</p>
<ul class="simple">
<li><p>sentences are separated by a <strong>newline</strong></p></li>
<li><p>tokens are separated by a <strong>space</strong> (unless a custom tokenizer is set, see <a class="reference internal" href="tokenization.html"><span class="doc std std-doc">Tokenization</span></a>)</p></li>
</ul>
<p>For example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ head -5 data/toy-ende/src-train.txt
It is not acceptable that , with the help of the national bureaucracies , Parliament &amp;apos;s legislative prerogative should be made null and void by means of implementing provisions whose content , purpose and extent are not laid down in advance .
Federal Master Trainer and Senior Instructor of the Italian Federation of Aerobic Fitness , Group Fitness , Postural Gym , Stretching and Pilates; from 2004 , he has been collaborating with Antiche Terme as personal Trainer and Instructor of Stretching , Pilates and Postural Gym .
&amp;quot; Two soldiers came up to me and told me that if I refuse to sleep with them , they will kill me . They beat me and ripped my clothes .
Yes , we also say that the European budget is not about the duplication of national budgets , but about delivering common goals beyond the capacity of nation states where European funds can realise economies of scale or create synergies .
The name of this site , and program name Title purchased will not be displayed .
</pre></div>
</div>
</section>
<section id="sequence-vector">
<h3>Sequence vector<a class="headerlink" href="#sequence-vector" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">opennmt.inputters.SequenceRecordInputter</span></code> expects a file with serialized <a class="reference external" href="https://www.tensorflow.org/tutorials/load_data/tfrecord"><em>TFRecords</em></a>. We propose 2 ways to create this file, choose the one that is the easiest for you:</p>
<section id="via-python">
<h4>via Python<a class="headerlink" href="#via-python" title="Permalink to this headline"></a></h4>
<p>It is very simple to generate a compatible <em>TFRecords</em> file directly from Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">opennmt</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">opennmt</span><span class="o">.</span><span class="n">inputters</span><span class="o">.</span><span class="n">create_sequence_records</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;data.records&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This example saves a dataset of 3 random vectors of shape <code class="docutils literal notranslate"><span class="pre">[time,</span> <span class="pre">dim]</span></code> into the file <code class="docutils literal notranslate"><span class="pre">data.records</span></code>. It should be easy to adapt for any dataset of 2D vectors.</p>
</section>
<section id="via-the-ark-text-format">
<h4>via the ARK text format<a class="headerlink" href="#via-the-ark-text-format" title="Permalink to this headline"></a></h4>
<p>The script <code class="docutils literal notranslate"><span class="pre">onmt-ark-to-records</span></code> proposes an alternative way to generate this dataset. It converts the ARK text format:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>KEY [
FEAT1.1 FEAT1.2 FEAT1.3 ... FEAT1.n
...
FEATm.1 FEATm.2 FEATm.3 ... FEATm.n ]
</pre></div>
</div>
<p>which describes an example of <code class="docutils literal notranslate"><span class="pre">m</span></code> vectors of depth <code class="docutils literal notranslate"><span class="pre">n</span></code> and identified by <code class="docutils literal notranslate"><span class="pre">KEY</span></code>.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">onmt-ark-to-records</span> <span class="pre">-h</span></code> for the script usage. It also accepts an optional indexed text file (i.e. with lines prefixed with <code class="docutils literal notranslate"><span class="pre">KEY</span></code>s) to generate aligned source vectors and target texts.</p>
</section>
</section>
</section>
<section id="parallel-and-nested-inputs">
<h2>Parallel and nested inputs<a class="headerlink" href="#parallel-and-nested-inputs" title="Permalink to this headline"></a></h2>
<p>When using <a class="reference external" href="https://opennmt.net/OpenNMT-tf/package/opennmt.inputters.ParallelInputter.html"><code class="docutils literal notranslate"><span class="pre">opennmt.inputters.ParallelInputter</span></code></a> to define multi-source inputs, as many input files as inputters are expected. You have to configure your YAML file accordingly:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train_features_file</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">train_source_1.records</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">train_source_2.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">train_source_3.txt</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ParallelInputter</span></code> can also be nested to enable complex inputs combination. In this case, the nested structure should be replicated in the YAML file. The example below represents the configuration for a dual-source model where the first source combines the embeddings of words, POS tags, and case:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train_features_file</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source_1.txt</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source_1.txt.pos</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source_1.txt.case</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source_2.txt</span>
</pre></div>
</div>
<p>During inference, the same number of input files should be provided. You should pass a <strong>flattened</strong> list of files to the <code class="docutils literal notranslate"><span class="pre">--features_file</span></code> command line option of the main script (e.g. for inference, evaluation, and scoring):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>onmt.main<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>infer<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--features_file<span class="w"> </span>test_source_1.records<span class="w"> </span>test_source_2.txt<span class="w"> </span>test_source_3.txt
</pre></div>
</div>
</section>
<section id="weighted-dataset">
<h2>Weighted dataset<a class="headerlink" href="#weighted-dataset" title="Permalink to this headline"></a></h2>
<p>It is possible to configure multiple training data files and assign weights to each file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train_features_file</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain_a.en</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain_b.en</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain_c.en</span>
<span class="w">  </span><span class="nt">train_labels_file</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain_a.de</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain_b.de</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain_c.de</span>
<span class="w">  </span><span class="nt">train_files_weights</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.3</span>
</pre></div>
</div>
<p>This configuration will create a weighted dataset where examples will be randomly sampled from the data files according to the provided weights. The weights are normalized by the file size so that examples from small files are not repeated more often than examples from large files during the training.</p>
</section>
<section id="compressed-data">
<h2>Compressed data<a class="headerlink" href="#compressed-data" title="Permalink to this headline"></a></h2>
<p>Data files compressed with GZIP are supported. The path should end with the <code class="docutils literal notranslate"><span class="pre">.gz</span></code> extension for the file to be correctly loaded:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train_features_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/wmt/train.en.gz</span>
<span class="w">  </span><span class="nt">train_labels_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/wmt/train.de.gz</span>
</pre></div>
</div>
</section>
<section id="data-location">
<h2>Data location<a class="headerlink" href="#data-location" title="Permalink to this headline"></a></h2>
<p>By default, the data are expected to be on the same filesystem. However, it is possible to reference data stored in HDFS, Amazon S3, or any other remote storages supported by TensorFlow. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train_features_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://namebucket/toy-ende/src-train.txt</span>
<span class="w">  </span><span class="nt">train_labels_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hdfs://namenode:8020/toy-ende/tgt-train.txt</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="configuration.html" class="btn btn-neutral float-left" title="Parameters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vocabulary.html" class="btn btn-neutral float-right" title="Vocabulary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>